"use strict";var e,t=require("vscode");function n(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}!function(e){e.NEVER="Never",e.SAVE="Save",e.ALWAYS="Always"}(e||(e={}));var i={}.toString,o=Array.isArray||function(e){return"[object Array]"==i.call(e)},s=o,r=o,a=function(e){return null!=e&&"object"==typeof e&&!1===s(e)},c=l;function l(e,t){if(!(this instanceof l))return"number"==typeof t?new l(e).fromIndex(t):new l(e,t);this.str=e||"",this.lineToIndex=function(e){for(var t=e.split("\n"),n=new Array(t.length),i=0,o=0,s=t.length;o<s;o++)n[o]=i,i+=t[o].length+1;return n}(this.str),t=t||{},this.origin=void 0===t.origin?1:t.origin}l.prototype.fromIndex=function(e){if(e<0||e>=this.str.length||isNaN(e))return null;var t=function(e,t){if(e>=t[t.length-1])return t.length-1;var n,i=0,o=t.length-2;for(;i<o;)if(e<t[n=i+(o-i>>1)])o=n-1;else{if(!(e>=t[n+1])){i=n;break}i=n+1}return i}(e,this.lineToIndex);return{line:t+this.origin,col:e-this.lineToIndex[t]+this.origin}},l.prototype.toIndex=function(e,t){if(void 0===t)return r(e)&&e.length>=2?this.toIndex(e[0],e[1]):a(e)&&"line"in e&&("col"in e||"column"in e)?this.toIndex(e.line,"col"in e?e.col:e.column):-1;if(isNaN(e)||isNaN(t))return-1;if(e-=this.origin,t-=this.origin,e>=0&&t>=0&&e<this.lineToIndex.length){var n=this.lineToIndex[e];if(t<(e===this.lineToIndex.length-1?this.str.length:this.lineToIndex[e+1])-n)return n+t}return-1};var g,u=n(c);function d(e){const t=/([.#])(-?[_a-zA-Z]+[_a-zA-Z0-9-]*)(?=[#.,()\s\[\]\^:*"'>=_a-zA-Z0-9-]*{[^}]*})/g,n=[],i=u(e,{origin:0});let o,s,r,a=0,c=0;for(;o=t.exec(e);)r=o.index,s=i.fromIndex(r),s&&(a=s.line,c=s.col+1),n.push({index:r,line:a,col:c,type:o[1],selector:o[2]});return n}!function(e){e.ID="#",e.CLASS="."}(g||(g={}));const h=new t.Position(0,0),f=new Map;const m=t.workspace.getConfiguration("css").get("enabledLanguages",["html"]),p=t.languages.createDiagnosticCollection(),w=new class{get isRemote(){return/^https?:\/\//i}get wordRange(){return/[_a-zA-Z0-9-]+/}get canComplete(){return/(id|class|className)\s*[=:]\s*(["'])(?:.(?!\2))*$/is}async fetch(e){try{const t=await fetch(e);if(t.ok)return t.text();throw new Error(t.statusText)}catch(n){t.window.showErrorMessage(`Fetching ${e} failed. ${n}`)}return""}async getRemote(e){let t=f.get(e);if(!t){t=d(await this.fetch(e)),f.set(e,t)}return t}async getLocal(e){const n=e.toString();let i=f.get(n);if(!i){i=d((await t.workspace.fs.readFile(e)).toString()),f.set(n,i)}return i}getRelativePattern(e,n){return new t.RelativePattern(e,n).pattern}async getStyles(e){const n=new Map,i=t.workspace.getWorkspaceFolder(e.uri),o=(s=e,t.workspace.getConfiguration("css",s).get("styleSheets",[]));var s;for(const e of o)if(this.isRemote.test(e))n.set(e,await this.getRemote(e));else if(i){const o=await t.workspace.findFiles(this.getRelativePattern(i,e));for(const e of o)n.set(e.toString(),await this.getLocal(e))}return n.set(e.uri.toString(),d(e.getText())),n}async getCompletionMap(e,n){const i=new Map,o=await this.getStyles(e);for(const e of o.values())for(const o of e)if(o.type===n){const e=new t.CompletionItem(o.selector,o.type===g.ID?t.CompletionItemKind.Value:t.CompletionItemKind.Enum);i.set(o.selector,e)}return i}async getCompletionItems(e,t,n){const i=await this.getCompletionMap(e,n),o=e.getWordRangeAtPosition(t,this.wordRange),s=[];for(const e of i.values())e.range=o,s.push(e);return s}provideCompletionItems(e,n,i,o){const s=new t.Range(h,n),r=e.getText(s),a=this.canComplete.exec(r);return new Promise(((t,o)=>a&&!i.isCancellationRequested?t(this.getCompletionItems(e,n,"id"===a[1]?g.ID:g.CLASS)):o()))}async getDefinitions(e,n){const i=await this.getStyles(e),o=e.getWordRangeAtPosition(n,this.wordRange),s=e.getText(o),r=[];for(const e of i)this.isRemote.test(e[0])||e[1].filter((e=>e.selector===s)).forEach((n=>r.push(new t.Location(t.Uri.parse(e[0]),new t.Position(n.line,n.col)))));return r}provideDefinition(e,n,i){const o=new t.Range(h,n),s=e.getText(o),r=this.canComplete.exec(s);return new Promise(((t,o)=>r&&!i.isCancellationRequested?t(this.getDefinitions(e,n)):o()))}async validate(e){const n=/([^(\[{}\])\s]+)(?![^(\[{]*[}\])])/gi,i=/(class|className)\s*[=:]\s*(["'])(.*?)\2/gis,o=[],s=await this.getCompletionMap(e,g.CLASS),r=e.getText();let a,c,l,u,d,h;for(;a=i.exec(r);)for(c=i.lastIndex-a[3].length+a[3].indexOf(a[2]);l=n.exec(a[3]);)s.has(l[1])||(u=n.lastIndex+c,d=e.positionAt(u),h=e.positionAt(u-l[1].length),o.push(new t.Diagnostic(new t.Range(h,d),`CSS selector '${l[1]}' not found.`,t.DiagnosticSeverity.Warning)));return o}};async function x(n,i){if(m.includes(n.languageId)){const s=(o=n,t.workspace.getConfiguration("css",o).get("autoValidation",e.NEVER));i&&i!==s?s!==e.ALWAYS&&p.delete(n.uri):p.set(n.uri,await w.validate(n))}var o}exports.activate=function(n){return n.subscriptions.push(t.languages.registerCompletionItemProvider(m,w),t.languages.registerDefinitionProvider(m,w),t.workspace.onDidSaveTextDocument((async t=>{var n;n=t.uri.toString(),f.delete(n),await x(t,e.SAVE)})),t.workspace.onDidOpenTextDocument((async t=>{await x(t,e.ALWAYS)})),t.workspace.onDidChangeTextDocument((async t=>{t.contentChanges.length>0&&await x(t.document,e.ALWAYS)})),t.workspace.onDidCloseTextDocument((e=>{p.delete(e.uri)})),t.commands.registerCommand("vscode-html-css.validate",(async e=>{const n=t.window.activeTextEditor;n&&await x(n.document,e)})),t.commands.registerCommand("vscode-html-css.clear",(()=>(t.window.showInformationMessage(`Style sheets cache cleared: ${f.size}`),void f.clear())))),t.commands.executeCommand("vscode-html-css.validate",e.ALWAYS)},exports.deactivate=function(){};
