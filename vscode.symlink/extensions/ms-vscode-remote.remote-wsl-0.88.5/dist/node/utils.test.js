(()=>{"use strict";var t={7485:(t,e,r)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.allPlatforms=void 0,e.getDownloadService=function(t,r,h,w,m){const{updateUrl:p,quality:g,commit:v}=h;return v&&g&&p?function(t,r,h,w,m,p,g){const v=p?.l10n??{t:t=>t},y=g??n.join(a.homedir(),"vscode-remote-wsl");let b,D=!1;return{start(){if(void 0!==b)return;let e,r,s=!1;m.write("Download in background is enabled"),w.update(f,!1),b=setInterval((async()=>{const n=(new Date).getTime();if(w.get(c,0)>n-d)s||(m.write("Update check by another window detected, skipping."),s=!0);else if(s=!1,w.update(c,n),!w.get(f,!1))try{w.update(f,!0);const s=await async function(t){if(!t)return;const e=t.workspace.getConfiguration().get("remote.WSL.downloadInBackgroundCommit");if(e)return e;const r=await t.commands.executeCommand("_update.state");return r&&r.update?r.update.version:void 0}(p);if(s)if(e!==s){if(m.write("New commit detected: "+s),r&&e!==t){try{m.write("Removing old download: "+r),o.promises.rm(r,{recursive:!0,force:!0})}catch(t){m.write("Ignoring error removing old download: "+r)}r=void 0}r=await x(s),e=s}else D&&(m.write("Checking for additional platform downloads for commit "+s),r=await x(s),D=!1)}catch(t){m.write("Problems getting update information "+(t.message||t.toString()))}finally{w.update(f,!1)}}),d)},stop(){b&&(clearInterval(b),b=void 0,m.write("Download in background is disabled"))},onPlatformUsed(t){t&&(w.update(l+t,(new Date).getTime()),D=!0)},getOrDownloadBuild:A};async function x(t){const r=function(){const t=(new Date).getTime();return e.allPlatforms.filter((e=>w.get(l+e,0)>t-u))}();if(0!==r.length){m.write("Recently used WSL platforms: "+r.join(", "));for(const e of r)await A(t,e,(()=>{}));return q(t,h)}m.write("No recently used WSL platforms found. Skipping download.")}async function A(t,e,s){const i=function(t,e,r,o){return`${t}/commit:${e}/server-${r}/${o||"insider"}`}(r,t,e,h),a=function(t,e,r){return n.join(q(e,t),`vscode-server-${t}-${r}.tar.gz`)}(h,t,e);return await async function(t){try{return(await o.promises.stat(t)).isFile()}catch(t){return!1}}(a)?m.write(`Found ${a}. Skipping download.`):(m.write(`Downloading VS Code Server ${h} - ${t} into ${a}.`),await async function(t,e,r){await o.promises.mkdir(n.dirname(e),{recursive:!0});const s=`${e}_${Date.now()}`;await k(t,s,r);try{await o.promises.rename(s,e)}catch(t){throw await S(s),t}return e}(i,a,s)),a}function S(t){return o.promises.unlink(t).catch((e=>{m.write(`Ignoring error when deleting ${t}: ${e}`)}))}function k(t,e,r,n=5,a=void 0){return new Promise(((u,d)=>{const l=async t=>{await S(e),d(t)},c=(0,o.createWriteStream)(e),f=i.get(t,(i=>{const f=i.headers["x-sha256"],h=i.headers["content-length"];if(a||"string"!=typeof f||(a=f),n>0&&(i.statusCode>=300&&i.statusCode<=303||307===i.statusCode)){const t=i.headers.location;if(t)return k(t,e,r,n-1,a).then(u,d),void i.resume()}if(i.statusCode<200||i.statusCode>299)return d(v.t("Failed to download VS Code Server from {0}: HTTP {1} - {2}",t,i.statusCode,i.statusMessage)),void i.resume();m.write(`Download checksum: ${a}`);const w=parseInt(i.headers["content-length"]||"0");if(w){let t=0,e=0;i.on("data",(o=>{t+=o.length,e++%8==0&&r({received:t,total:w})}))}i.once("error",l),i.pipe(c),c.once("finish",(async()=>{const t=await async function(t,e,r){if(e)return new Promise((r=>{const n=s.createHash("sha256"),i=(0,o.createReadStream)(t);i.on("data",(t=>n.update(t))),i.on("end",(()=>r(e!==n.digest("hex")?v.t("Download checksum does not match."):void 0)))}));if(r)return(await o.promises.stat(t)).size!==parseInt(r)?v.t("Download length does not match."):void 0}(e,a,h);t?l(t):(void 0!==a&&m.write("Download checksum verified"),void 0!==a&&m.write("Download length verified"),u())})),c.once("error",l)}));f.on("error",l),f.end()}))}function q(t,e){return n.join(y,e,t||"dev")}}(v,p,g,t,r,w,m):{start(){},stop(){},onPlatformUsed(){},getOrDownloadBuild:async()=>""}};const o=r(9896),s=r(6982),n=r(6928),i=r(5692),a=r(857),u=12096e5,d=3e4,l="wsl.usageTime.",c="wsl.lastUpdateCheck",f="wsl.downloadInProgress";e.allPlatforms=["linux-x64","linux-alpine","linux-arm64","alpine-arm64","linux-legacy-x64","linux-legacy-arm64"]},2552:(t,e)=>{function r(t,e){return t.length===e.length&&(t===e||t.toLowerCase()===e.toLowerCase())}Object.defineProperty(e,"__esModule",{value:!0}),e.AuthorityHierarchy=void 0,e.compareCaseInsensitive=r,e.isEqualAuthority=function(t,e){return void 0===t?void 0===e:void 0!==e&&r(t,e)},e.isDockerDesktopDistro=function(t){return/^docker-desktop(-data)?$/.test(t)},e.isWSL1=function(t){return-1!==t.indexOf("Microsoft")},e.getAuthorityFromDistro=function(t="default",e){return e?`wsl+${t}@${e}`:"wsl+"+t},e.isAuthorityWsl=function(t){return t.startsWith("wsl+")},e.getDistroFromAuthority=function(t){let e,r;if(t.startsWith("wsl+")&&(e=t.substring(4)),!e)return;const o=e.indexOf("@"),s=e.indexOf("%40"),n=Math.min(-1===o?1/0:o,-1===s?1/0:s);return isFinite(n)&&(r=e.slice(n+1),e=e.slice(0,n)),"default"===e&&(e=void 0),{hostAuthority:r,distro:e}},e.getRemoteName=function(t){const e=t.indexOf("+");return-1!==e?t.substring(0,e):t},e.onceSuccessfully=function(t){let e;return()=>(void 0!==e||(e=t(),e.catch((()=>{e=void 0}))),e)},e.shouldActivateForAuthority=function(t,e){const r=["tunnel+","wsl+"];return!1!==t.workspace.getConfiguration("remote.SSH").get("useExecServer",!0)&&r.push("ssh-remote+"),r.some((t=>e.startsWith(t)))};class o{static parse(t){return new o(t,t.split(/@|%40/g).reverse())}get length(){return this.parts.length}get host(){return this.last.startsWith("wsl+")?1===this.parts.length?void 0:this.parts.slice(0,-1).reverse().join("@"):this.parts.slice().reverse().join("@")}get last(){return this.parts[this.parts.length-1]}constructor(t,e){this.value=t,this.parts=e}has(t){const e=t+"+";return this.parts.some((t=>t.startsWith(e)))}toString(){return this.parts.join(" > ")}}e.AuthorityHierarchy=o},2613:t=>{t.exports=require("assert")},6982:t=>{t.exports=require("crypto")},9896:t=>{t.exports=require("fs")},5692:t=>{t.exports=require("https")},857:t=>{t.exports=require("os")},6928:t=>{t.exports=require("path")}},e={};function r(o){var s=e[o];if(void 0!==s)return s.exports;var n=e[o]={exports:{}};return t[o](n,n.exports,r),n.exports}var o={};(()=>{var t=o;Object.defineProperty(t,"__esModule",{value:!0});const e=r(7485),s=r(2552),n=r(2613),i=r(9896),a=r(857),u=r(6928);suite("distro in authority",(()=>{test("default",(function(){n.equal((0,s.getAuthorityFromDistro)(),"wsl+default"),n.deepEqual((0,s.getDistroFromAuthority)("wsl+default"),{distro:void 0,hostAuthority:void 0})})),test("simple",(function(){n.equal((0,s.getAuthorityFromDistro)("ubuntu"),"wsl+ubuntu"),n.deepEqual((0,s.getDistroFromAuthority)("wsl+ubuntu"),{distro:"ubuntu",hostAuthority:void 0}),n.equal((0,s.getAuthorityFromDistro)("ubuntu-18.04"),"wsl+ubuntu-18.04"),n.deepEqual((0,s.getDistroFromAuthority)("wsl+ubuntu-18.04"),{distro:"ubuntu-18.04",hostAuthority:void 0})})),test("hosted",(function(){n.equal((0,s.getAuthorityFromDistro)("ubuntu","tunnel+surface"),"wsl+ubuntu@tunnel+surface"),n.deepEqual((0,s.getDistroFromAuthority)("wsl+ubuntu@tunnel+surface"),{distro:"ubuntu",hostAuthority:"tunnel+surface"}),n.equal((0,s.getAuthorityFromDistro)(void 0,"tunnel+surface"),"wsl+default@tunnel+surface"),n.deepEqual((0,s.getDistroFromAuthority)("wsl+default@tunnel+surface"),{distro:void 0,hostAuthority:"tunnel+surface"})}))}));class d{constructor(){this.storage=new Map}get(t,e){return this.storage.get(t)??e}async update(t,e){this.storage.set(t,e)}}class l{constructor(){this.messages=[]}write(t,e){this.messages.push({text:t,level:e})}}suite("download service",(()=>{for(const t of e.allPlatforms)test("download "+t,(async function(){const r=new d,o=new l,s=u.join(a.tmpdir(),"test-vscode-remote-wsl-"+(new Date).getTime()),c=(0,e.getDownloadService)(r,o,{commit:"384ff7382de624fb94dbaf6da11977bba1ecd427",quality:"stable",serverApplicationName:"VS Code Test",updateUrl:"https://update.code.visualstudio.com"},void 0,s),f=await c.getOrDownloadBuild("384ff7382de624fb94dbaf6da11977bba1ecd427",t,(()=>{})),h=i.statSync(f);n.ok(h.size>0)})).timeout(6e4)}))})();var s=exports;for(var n in o)s[n]=o[n];o.__esModule&&Object.defineProperty(s,"__esModule",{value:!0})})();
//# sourceMappingURL=utils.test.js.map